/* HMT project Mandatory Ongoing Maintenance. Summer 2014 version.
*/
buildscript {
    repositories {
        mavenCentral()
	maven {
	  url "http://beta.hpcc.uh.edu/nexus/content/groups/public"
	}
    }
    dependencies {
      classpath group: 'org.homermultitext', name : 'citemgr' , version: '0.4.2'
      classpath group: 'edu.harvard.chs', name : 'cite' , version: '0.14.2'
    }
}

import org.homermultitext.citemanager.DseManager
import edu.harvard.chs.cite.CiteUrn

import org.apache.tools.ant.filters.*

apply plugin: "base"
apply plugin:  "groovy"
apply plugin:  "maven"


//apply from: "pubconf.gradle"
apply from: "versions.gradle"


if (hasProperty('conf')) {
    System.err.println "Using configuration data from ${conf}"
    File confFile = new File(conf)
    if (! confFile.exists()) {
        throw new Exception("No configuration file ${conf} found.")
    }
    apply from: conf

} else {
    File confFile = new File("conf.gradle")
    if (! confFile.exists()) {
        throw new Exception("No configuration file ${conf} found.")
    }
    apply from: "conf.gradle"
}



group = "org.homermultitext"
version = '0.4.0'


repositories {
    mavenCentral()
    maven {
        url "http://beta.hpcc.uh.edu/nexus/content/groups/public"
    }
}

dependencies {
  compile group: 'org.codehaus.groovy', name: 'groovy-all', version: groovyVersion
  compile group: 'org.homermultitext', name : 'citemgr' , version: citemgrversion
  compile group: 'edu.harvard.chs', name : 'cite' , version: citeversion

  /*
    compile group: 'org.homermultitext', name : 'dse' , version: dseversion


    compile group: "edu.holycross.shot", name: "hocuspocus", version: hocuspocusversion
    compile group: 'edu.harvard.chs', name : 'greekutils' , version: greekutilsversion
    testCompile group: 'junit', name: 'junit', version: '4.8.2'
    compile group: 'com.thaiopensource', name:'jing', version: '20091111'
    compile group: 'net.sf.saxon', name: 'saxon-dom', version: '8.7'
    compile group: 'org.codehaus.groovy.modules.http-builder', name: 'http-builder', version: '0.5.2'	
  */
}



task setUpVisInv(type: Copy) {
  from "visualinventory"
  into "${buildDir}/visualinventory"
}

task visinv(dependsOn : [setUpVisInv]) {
  description = "Creates XML visual inventory for conifgured folio."
}



visinv.doLast {
  DseManager dse = new DseManager()

  folioToImage.split(/,/).each { idx ->
      if (dse.tbsImageIndexFiles) {
	dse.tbsImageIndexFiles.add(new File(idx))
      } else {
	dse.tbsImageIndexFiles = [new File(idx)]
      }
  }

  textToImage.split(/,/).each { idx ->
    if (dse.textImageIndexFiles) {
      dse.textImageIndexFiles.add(new File(idx))
    } else {
      dse.textImageIndexFiles = [new File(idx)]
    }
  }



  textToFolio.split(/,/).each { idx ->
    if (dse.textTbsIndexFiles) {
      dse.textTbsIndexFiles.add(new File(idx))
    } else {
      dse.textTbsIndexFiles = [new File(idx)]
    }
  }

  CiteUrn urn = new CiteUrn(folio)
  String xml =  dse.getVisualInventoryXml(urn)
  File visinv = new File("${buildDir}/visualinventory/inventory.xml")
  visinv.setText(xml,"UTF-8")
}


task verify(type:  JavaExec, dependsOn: [compileGroovy, visinv]) {
    description = "Runs full verification suite on requested URN(s)"
    main = "org.homermultitext.mom.Verifier"
    args = [folio, folioToImage, textToImage, textToFolio, buildDir]


    classpath sourceSets.main.output.classesDir
    classpath configurations.runtime
}

verify.doFirst {
  System.out.println "Verifying folio ${folio}\n"
}


verify.doLast {
  System.out.println "Completed verification."
  System.out.println "\nMOM version: ${version}"
}